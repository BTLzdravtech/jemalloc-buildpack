#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e

# parse params
BUILD_DIR=$1
CACHE_DIR=$2

url="https://github.com/mojodna/heroku-buildpack-jemalloc/releases/download/v5.0.0/jemalloc-5.0.0-1.tar.gz"
dest="$BUILD_DIR/vendor/jemalloc"

echo "-----> Vendoring jemalloc"
echo "       Fetching $url"

mkdir -p $dest
curl -sL $url | tar -C $dest -xz

echo "-----> Building runtime environment"
mkdir -p $BUILD_DIR/.profile.d

cat <<EOF > $BUILD_DIR/.profile.d/jemalloc.sh
export PATH="$PATH:/app/vendor/jemalloc/bin"
EOF
